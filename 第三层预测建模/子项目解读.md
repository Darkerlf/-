# 第三层预测建模｜销量预测与爆款识别（机器学习）子项目解读

> 说明：本文中出现的相对路径，默认以项目根目录 `E:\PycharmProjects\三创赛` 为基准。

## 1. 子项目定位（在全链路中的作用）

本层将“产品属性 + 评论信号 + NLP 洞察”融合为可训练特征，构建：

1. **销量代理预测（回归）**：预测 `bought_count_number_clean`（页面展示的购买量信号）
2. **爆款识别（分类）**：识别“潜在爆款/高潜商品”

并输出一整套**可解释性图表**（特征重要性、SHAP、业务看板），用于比赛答辩展示“可落地决策支持”。

---

## 2. 本层使用的数据（输入文件）

目录：`第三层预测建模/data/`

- `products_clean.csv`：产品维表（价格、BSR、图片数、折扣、FBA 等）
- `reviews_cleaned.csv`：评论清洗表
- `agg_product.csv`：商品级评论聚合特征
- `bert_sentiment_results.csv`：BERT 情感结果（review 粒度）
- `absa_detailed.csv`：方面级情感明细（review×aspect 粒度）

脚本会把 BERT/ABSA 聚合到 ASIN 级，与产品/评论聚合表拼接后建模。

---

## 3. 核心脚本：`ml_sales_prediction.py` 做了什么

### 3.1 目标变量（你在项目书中必须讲清楚的“口径”）

- **回归目标**：`log1p(bought_count_number_clean)`
  - `bought_count_number_clean` 来源于产品页 `bought_count` 文本的数值化（非官方销量）
  - 使用 `log1p` 缓解长尾分布（销量极不均匀）

- **分类目标（爆款）**：`is_hot`
  - 规则：`bought_count_number_clean >= 1000` **或** `bsr_rank <= 5000`
  - 解释：把“购买量强”或“平台排名高”视为爆款代理标准

> 项目书建议：明确写成“销量代理指标（proxy）”，并说明为何用 proxy（亚马逊不公开真实销量）。

### 3.2 特征工程（关键技术点）

特征来源分三类（对应项目书的“多源特征融合”）：

1. **基础/Listing 特征**（来自 `products_clean.csv`）
   - `price_num`, `discount_rate`, `image_count`, `bullet_count`, `is_fba`, `has_aplus`
   - `bsr_rank`（并做对数变换 `log_bsr_rank` + 逆变换 `bsr_rank_inv`）

2. **评论聚合特征**（来自 `agg_product.csv`）
   - `sample_review_n`, `verified_ratio`, `avg_text_len`, `helpful_mean`, `has_text_ratio`

3. **NLP 特征**（来自 `bert_sentiment_results.csv` + `absa_detailed.csv`）
   - BERT：`avg_bert_score`, `positive_ratio`, `std_bert_score`
   - ABSA：各方面情感均值（sharpness/quality/rust/…）

### 3.3 建模方法（技术栈）

- 回归：XGBoost / LightGBM / GradientBoosting / RandomForest（缺库时自动降级）
- 分类：RandomForestClassifier
- 评估：RMSE/MAE/R²、Accuracy/Precision/Recall/F1/AUC，KFold/StratifiedKFold
- 可解释性：SHAP（缺库时用内置 feature_importances_）

---

## 4. 输出数据与图像（产物清单 + 代表含义）

输出目录：`第三层预测建模/output/`

### 4.1 报告与数据

- `output/reports/model_report.md`：模型性能与关键发现（项目书可直接引用）
- `output/reports/feature_importance.csv`：特征重要性表（用于“驱动因素排序”）
- `output/models/*.pkl`：训练好的模型（用于复现实验或后续上线）

### 4.2 图像（用于项目书/PPT）

目录：`output/figures/`

- `model_comparison.png`：多模型回归效果对比（RMSE/MAE/R²）
  - 写法：*“图X 对比多种回归模型，RandomForest 在当前数据上表现最佳（R²≈0.60），说明非线性特征交互对销量代理预测更有效。”*

- `feature_importance.png`：特征重要性排序
  - 写法：*“图X 显示 BSR 排名、评论正面比例、价格等是影响销量的核心因素，为选品与运营提供量化依据。”*

- `shap_summary.png`：SHAP 总结图（方向性解释：高/低取值如何影响预测）
  - 写法：*“图X 用 SHAP 解释模型决策：更好的 BSR（更靠前）、更高的正面评论占比显著抬升销量预测；负面方面（如 rust）会拉低销量预期。”*

- `prediction_scatter.png`：真实 vs 预测散点（拟合程度）
  - 写法：*“图X 展示预测与真实值整体呈正相关，模型对中高销量段拟合较好，极端长尾仍存在误差（符合电商长尾规律）。”*

- `classification_results.png`：爆款分类结果（混淆矩阵/ROC 等）
  - 写法：*“图X 说明爆款识别具有较高 AUC（≈0.95），可用于快速筛选高潜商品池。”*

- `cv_results.png`：交叉验证稳定性
  - 写法：*“图X 展示不同折数下指标波动，证明模型在样本切分下具有一定鲁棒性。”*

- `rating_sales_analysis.png`：评分×销量关系（核心业务展示图）
  - 典型讲法：评分提升带来的销量分布变化；不同正面率对应销量差异；以及 ABSA 方面与销量相关性

- `business_insights_dashboard.png`：业务洞察看板（多图合一）
  - 写法：*“图X 将价格-评分-销量、品牌表现、关键驱动因素汇总到一页，用于决策层快速阅读。”*

---

## 5. 项目书中如何写“结论与建议”（可直接引用/改写）

可围绕 `output/reports/model_report.md` 的“关键发现”组织：

1. **平台排名（BSR）是最强驱动**：排名越靠前，销量代理越高（模型重要性最高）。
2. **评论质量优于数量**：正面评论占比对销量影响显著；仅堆评论数不如提升满意度。
3. **痛点会拖累销量**：例如 rust（防锈）相关负面情绪与销量呈负相关，应优先优化工艺与质保。
4. **价格存在优势区间**：中端价位（如 $30-$80）更易形成销量（需结合竞品密度进一步验证）。
5. **FBA 与优质 Listing 有加成**：FBA、更多图片与更完整要点（bullet）提升转化信号。

---

## 6. 复现运行方式

在 `第三层预测建模/` 下：

```bash
pip install -r requirements.txt
python ml_sales_prediction.py
```

运行后产物写入 `output/`。

---

## 7. 注意事项（口径与风险）

- 目标变量是“销量代理（proxy）”而非真实销量；项目书建议增加一句：*“由于平台不公开真实销量，本研究采用页面展示的购买量提示与排名指标构建销量代理，并通过多模型对比与交叉验证保证结论稳健。”*
- 可建模样本仅包含 `bought_count_number_clean` 不为空的商品（样本量会小于总商品数），在报告中应说明样本筛选规则。
